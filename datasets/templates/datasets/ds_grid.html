<!-- datasets/ds_grid.html -->
{% extends "main/base.html" %}
{% load leaflet_tags %}
{% load fontawesome %}
{% load static %}

{% block title %}<title>Dataset {{ ds.id }}</title>{% endblock %}
{% block extra_head %}{% endblock %}
{% block content %}
<!-- incoming: ds, place_list -->
<div class="container flex">
<h4 class="mt-3">{{ ds.name }} ({{ ds.label }})</h4>
<div class="row">
  <div id="map_detail" class="col-sm-4 col-record pt-3">
    <div id="place_detail">
      <p>
        place record detail here, inserted by JavaScript
      </p>
    </div>
    <!-- <div id="map">{# leaflet_map "map" callback="map_init" #}</div> -->
  </div>
  <div id="data_grid" class="col-sm-8 pt-6">
    <table class="table table-striped">
        <thead>
            <th></th>
            <th>name</th>
            <th>place_id</th>
            <th>src_id</th>
            <!-- <th>parent</th> -->
            <th>ccode(s)</th>
            <!-- <th>lon, lat</th> -->
        </thead>
        <tbody>
          {% for place in place_list %}
            <tr class="place-row">
              <td><span class="edit-row" style="cursor:pointer;">
                {% fontawesome_icon 'edit' color='#336699' %}</span</td>
              <td>{{ place.title }}</td>
              <td>{{ place.id }}</td>
              <td>{{ place.src_id }}</td>
              <!-- <td>{{ place.related }}</td> -->
              <td>{{ place.ccodes }}</td>
              <!-- <td>{{ place.placegeom_set.all }}</td> -->
            </tr>
          {% endfor %}
        </tbody>
    </table>
  </div>
</div>
</div>
<script type="text/javascript">
  // expose leaflet map for events, call it 'mappy'
  window.addEventListener('map:init', function (e) {
    window.mappy = e.detail.map
  }, false);

  // TODO: better parsing here
  function parsePlace(data) {
    window.data = data
    console.log(data.links[0])
    html='<div><h5 class="text-danger"><b>'
      +data['title']+'</b></h5>'
    html+='<p><b>Names</b>: '+ data.names[0].toponym +'</p>'
    + '<p><b>Types</b>: '+ data.types[0].label +' ('+data.types[0].source_label+')</p>'

    if (data.related.length > 0) {
      if (data.related[0].relation_type == 'gvp:broaderPartitive'){
        html+='<p><b>Parent</b>: '+ data.related[0].label +'</p>'
      }
      else {
        html+='<p><b>Related</b>: '+ data.related[0].label +'</p>'
      }
    }

    html_close = '<p class="mb-0"><b>closeMatches</b>: </p>'
    html_exact = '<p class="mb-0"><b>exactMatches</b>: </p>'
    close_count = exact_count = 0
    for (l in data.links) {
      if (data.links[l].type == 'closeMatch') {
        close_count += 1
        html_close+='<p>'+ data.links[l].identifier +'</p>'
      }
      else if (data.links[l].type == 'exactMatch') {
        exact_count += 1
        html_exact+='<p>'+ data.links[l].identifier +'</p>'
      }
    }
    if (close_count > 0) html += html_close
    if (exact_count > 0) html += html_exact

    if (data.ccodes.length > 0) {
      html+='<p><b>Countries</b>: '+ data.ccodes +'</p>'
    }
    // for (var key in data){
    //   if (['ccodes','names','types','links'].includes(key)) {
    //     html+='<p class="place-detail"><b>'+[key]+
    //       '</b>: '+JSON.stringify(data[key])+'</p>';
    //   }
    // }
    html += '</div>'
    return html
  }

  function getPlace(pid){
    $.ajax({
      url: "/api/places/"+pid,
      }).done(function( data ) {
        $("#place_detail").html(parsePlace(data))
      });
  }

  $(function(){
    // initialize with detail for first place in list
    row = $("#data_grid table tbody")[0].rows[0]
    pid = parseInt(row.cells[2].textContent)
    // populate place detail
    getPlace(pid)
  })

  $(".place-row").on("click", function(e){
    // TODO: render it in an editable Django form
    row = $(this)[0]
    pid = parseInt(row.cells[2].textContent)
    console.log('this',$(this))
    console.log('pid',pid)
    getPlace(pid)
  })

  // initialize, render map
  function map_init (map, options) {
    $('.edit-row').on('click', function(){
      alert('open a modal with full record')
    })
    console.log('in map_init()')
    geom = {"type":"FeatureCollecton","features":[]}

    window.gelems = $('script').filter(function() {
      return this.id.match(/[0-9]/);
    });
    for (i=0;i<gelems.length;i++){
      let t_geom = JSON.parse(JSON.parse(gelems[i].text))
      t_geom['properties'] = {"id": gelems[i].id, "dataset": "tgn"}
      geom['features'].push(t_geom)
    }

    function fill(dataset) {
      if (dataset == 'tgn')
        return "#ff7800"
      else if (dataset == 'dbp')
        return "#98E2FA"
      else
        return "#7AFF7A"
    }

    if (geom['features'].length > 0) {
      console.log('geom: ',geom)
      idToFeature = {} // for feature lookup
      features = L.geoJSON(geom, {
        pointToLayer: function (feature, latlng) {
          matchid = feature.properties.dataset+':'+feature.properties.id
          marker = L.circleMarker(latlng,
            {
              radius: 8, fillOpacity: 0.8, opacity: 1, weight: 1,
              color: "#000", fillColor: fill(feature.properties.dataset)
            }
          ).bindPopup(feature.properties.dataset+':'+feature.properties.id);

          idToFeature[matchid] = marker
          return marker
        }
      }).addTo(map);

      if (geom['features'].length > 1) {
        map.fitBounds(features.getBounds().pad(1))
      } else {
        latlng = L.latLng(
          geom['features'][0].coordinates[1],
          geom['features'][0].coordinates[0])
        map.setView(latlng, 4)
      }

    } else {
      console.log('no geometries, no feature')
    }
  } // end map_init
  // zoom on click
  function zoomTo(id) {
    mappy.setView(idToFeature[id]._latlng, mappy.getZoom() +2 )
  }

</script>
{% endblock %}
