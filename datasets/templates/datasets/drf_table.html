<!-- datasets/ds_grid.html -->
{% extends "main/base.html" %}
{% load leaflet_tags %}
{% load fontawesome %}
{% load static %}

{% block title %}<title>Dataset {{ ds.id }}</title>{% endblock %}
{% block extra_head %}
  {% leaflet_js %}
  {% leaflet_css %}
  <link rel="stylesheet" href="//cdn.datatables.net/1.10.16/css/dataTables.bootstrap4.min.css">
{% endblock %}
{% block content %}
<!-- incoming: ds, place_list -->
<div class="container">
  <h4 class="mt-3">{{ ds.name }} <span class="small text-muted">[#{{ ds.label }}]</span></h4>
  <div class="container mt-3">
    <div class="row">
      <div id="drftable_detail" class="col-sm-5 pl-0">
        <div id="drftable_fields">
          <!--<p class="text-center mt-5">-->
            <!--<img src="{# static 'images/ajax-loader.gif' #}" />-->
          <!--</p>-->
        </div>
        <div id="map">
            {% leaflet_map "map" callback="map_init" %}
        </div>
      </div>
      <div id="drftable_list" class="col-sm-7">
        <table id="placetable" class="table table-striped table-bordered" style="width:100%">
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
            </tr>
          </thead>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="//cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
<script src="//cdn.datatables.net/1.10.16/js/dataTables.bootstrap4.min.js"></script>
<script>
  $(function() {
    var table = $('#placetable').DataTable({
      "serverSide": true,
      "ajax": "/api/places/?format=datatables&ds={{ ds.label }}",
      "columns": [
          {"data": "id", "searchable": false},
          {"data": "title"},
      ]
    })
  })
  setTimeout(function() {
    $( "tr.odd, tr.even" ).hover(
      function() {
        $(this).addClass( "rowhover" );
      }, function() {
        $(this).removeClass( "rowhover" );
      }
    )
    $( "tr.odd, tr.even" ).click(
      function() {
        pid=$(this)[0].cells[0].textContent
        getPlace(pid)
      }
    ) 
    row = $("#drftable_list table tbody")[0].rows[0]
    pid = parseInt(row.cells[0].textContent)
    // populate place detail
    getPlace(pid)
  }, 500) 
  
</script>
<script type="text/javascript">
  // expose leaflet map for events, call it 'mappy'
  window.addEventListener('map:init', function (e) {
    window.mappy = e.detail.map
  }, false);

  // TODO: better parsing here
  function parsePlace(data) {
    window.data = data
    // console.log(data.links[0])
    html='<div><h5 class="text-danger mb-4"><b>'
      +data['title']+'</b></h5>'

    // NAME VARIANTS
    html+='<p><b>Variants</b>: '
    for (n in data.names) {
      html+= '<p>'+data.names[n].toponym !=''?data.names[n].toponym+'; ': ''
    }

    // TYPES
    html+='</p><p><b>Types</b>: '+ data.types[0].label +' ('+data.types[0].source_label+')</p>'

    // GEOMS
    if (data.geoms.length > 0){
      html+='<p class="mb-0"><b>Geometry</b></<p>: '
      for (g in data.geoms){
        html+='<p class="small">'+data.geoms[g].coordinates + ' ('+data.geoms[g]['citation']['id']+')</p>'
      }
    }

    // LINKS
    html_close = '<p class="mb-0"><b>closeMatches</b>: </p>'
    html_exact = '<p class="mb-0"><b>exactMatches</b>: </p>'
    close_count = exact_count = 0
    for (l in data.links) {
      if (data.links[l].type == 'closeMatch') {
        close_count += 1
        html_close+='<p class="small">'+ data.links[l].identifier +'</p>'
      }
      else if (data.links[l].type == 'exactMatch') {
        exact_count += 1
        html_exact+='<p class="small">'+ data.links[l].identifier +'</p>'
      }
    }
    if (close_count > 0) html += html_close
    if (exact_count > 0) html += html_exact

    // CCODES
    if (data.ccodes.length > 0) {
      html+='<p><b>Countries</b>: '+ data.ccodes +'</p>'
    }

    // RELATED
    // if (data.related.length > 0) {
    //   if (data.related[0].relation_type == 'gvp:broaderPartitive'){
    //     html+='<p><b>Parent</b>: '+ data.related[0].label +'</p>'
    //   }
    //   else {
    //     html+='<p><b>Related</b>: '+ data.related[0].label +'</p>'
    //   }
    // }

    html += '</div>'
    return html
  }

  function getPlace(pid){
    $.ajax({
      url: "/api/places/"+pid,
      }).done(function( data ) {
        $("#drftable_fields").html(parsePlace(data))
      });
  }

  
  
  // initialize, render map
  function map_init (map, options) {
    $('.edit-row').on('click', function(){
      alert('open a modal with full record')
    })
    // console.log('in map_init()')
    geom = {"type":"FeatureCollecton","features":[]}
  } // end map_init
  
  function zoomTo(id) {
    mappy.setView(idToFeature[id]._latlng, mappy.getZoom() +2 )
  }

</script>
<!-- set aside from previous -->
<!--<script>-->
  <!--$(function(){-->
    <!--// initialize with detail for first place in list-->
    <!--row = $("#grid_list table tbody")[0].rows[0]-->
    <!--pid = parseInt(row.cells[1].textContent)-->
    <!--// populate place detail-->
    <!--getPlace(pid)-->
  <!--})-->

  <!--$(".place-row").on("click", function(e){-->
    <!--// TODO: render it in an editable Django form-->
    <!--row = $(this)[0]-->
    <!--pid = parseInt(row.cells[1].textContent)-->
    <!--// console.log('this',$(this))-->
    <!--// console.log('pid',pid)-->
    <!--getPlace(pid)-->
  <!--})-->
<!--</script>-->

{% endblock %}

