<!-- datasets/review.html -->
{% extends "main/base.html" %}
{% load leaflet_tags %}
{% load fontawesome %}
{% load static %}

{% block title %}<title>Dataset {{ ds.label }}</title>{% endblock %}
{% block extra_head %}
{% endblock %}
{% block content %}
<div class="container">
  <!-- incoming: ds, hit_list -->
  <h4 class="mb-3 mt-3">
    {{ authority }} <span class="text-danger small">[ #{{ ds_label }} ]</span>
    <span class="half float-right">task id: {{ task_id }}</span></h4>
  <div class="pagination d-flex justify-content-center">
    <span class="step-links">
        {% if records.has_previous %}
            <a href="?page=1">&laquo; first</a>&nbsp;&nbsp;
            <a href="?page={{ records.previous_page_number }}">previous</a>
        {% endif %}
        <span class="current">
            Record {{ records.number }} of {{ records.paginator.num_pages }}
        </span>
        {% if records.has_next %}
            <a href="?page={{ records.next_page_number }}">next</a>&nbsp;&nbsp;
            <a href="?page={{ records.paginator.num_pages }}">last &raquo;</a>
        {% endif %}
    </span>
  </div>
  {% for record in records %} <!-- there is only one; if last, do nothing -->
    {% if records.has_next %}
    <form id="form_related" method="POST" action="" >
      {% else %}
    <form id="form_related" method="POST" action="" >
    {% endif %}
    {% csrf_token %}
    {{ formset.management_form }}
    <input type="hidden" name="placeid" value="{{ record.placeid }}" />
    <div class="container">
      <hr/>
      <div class="row">
        <div id="review_record" class="col-sm-4 pl-0">
          <div class="bg-secondary font-weight-bold pl-2 text-light">{{ dataset_label }}</div>
          <div id="place-record">
            <div>
              <span><h4 class="text-danger">{{ record.title }} </h4></span>
              <span class="float-right">
                <button type="submit" class="btn btn-secondary float-right">Save</button>
              </span>
            </div>
            <p><strong>Source id</strong>: {{ record.src_id }}</p>
            <p><strong>Name variants</strong>:
              {% for name in record.names.all %}
               {{ name.json.toponym }};
              {% endfor %}</p>
            <p><strong>Place type(s)</strong>:
              {% for type in record.types.all %}
                <br/>{{ type.json.label }} ({{ type.json.src_label }})
            {% endfor %}</p>
            <!-- TODO: full place record -->
          </div>
          <div id="map">
            {% leaflet_map "map" callback="map_init" %}
          </div>
        </div>
        <div id="review_list" class="col-sm-8 pr-0">
            {% for form in formset %}
              <input type="hidden" name="tgnid" value='{{ form.tgnid.value }}'></input>
              <div class="pl-2 pr-2 matchbar">
                <span class="custom-control custom-radio match_radio">
                  {{ form.match }}
                  {% if form.json.value|get:"location" != Null %}
                    {{ form.json.value|get:"location"|safe|json_script:form.authrecord_id.value }}
                    <!-- {{ form.json.value|get:"location"|safe|json_script:form.authrecord_id.value }} -->
                    {{ form.flag_geom }} flag
                    <a class="geolink" id="{{ form.authrecord_id.value }}" href="javascript:{ zoomTo('tgn:'+{{ form.authrecord_id.value }}) }">geometry</a>
                  {% endif %}
                  <span class="noteicon">{% fontawesome_icon 'comment' color='#666666' %}</span>
                </span>
                <div class="notefield">{{ form.review_note}}</div>
              </div>
              {{ form.non_field_errors }}
              <div id="tgn_match" class="bg-light pl-2">
                  <p><strong>tgnid</strong>: {{ form.authrecord_id.value }}</p>
                    <p><strong>Names</strong>:
                      {% for n in form.json.value|get:"names" %}
                        {{ n.name|add:"; " }}
                      {% endfor %}
                    </p>
                    <p class="mt-2"><strong>Types</strong>:
                      {% for t in form.json.value|get:"types" %}
                        {{ t.placetype|add:"; " }}
                      {% endfor %}</p>
                  <p><strong>Parents</strong>: {{ form.json.value|get:"parents" }}</p>
                  <p><strong>Note</strong>: {{ form.json.value|get:"note" }}</p>
              </div>
            {% endfor %}
          </div>
      </div> <!-- .row -->
    </div> <!-- container flex -->
    </form>
  {% endfor %} <!-- record in records -->
</div> <!-- .container -->
<script type="text/javascript">
    $(function(){
      // defaults to string 'None' - no idea why
      $('.textarea').html('')
    })
    // expose leaflet map for events, call it 'mappy'
    window.addEventListener('map:init', function (e) {
      window.mappy = e.detail.map
    }, false);

    $('.noteicon').on('click', function(){
      $(this).parents(".matchbar").find(".notefield").toggle()
      // console.log('clicked',$(this).parents(".matchbar").find(".notefield"))
    })

    $('.noteicon').hover(function(){
      console.log('hovering')
    })

    $( ".geolink" ).hover(
      function() {
        let id = 'tgn:'+$(this)[0].id.toString()
        feat = idToFeature[id]
        feat.setStyle(
          {radius: 10, fillColor: 'red'}
        )
      },
      function() {
        let id = 'tgn:'+$(this)[0].id.toString()
        feat = idToFeature[id]
        feat.setStyle(
          {radius: 8, fillColor: '#ff7800'}
        )
      }
    );

    // closer look
    function zoomTo(id) {
      mappy.setView(idToFeature[id]._latlng, mappy.getZoom() +2 )
    }

    function cleanJson(text) {
      z=text.replace(/'/g,'\\"')
      y=z.replace(/point/,'Point')
      return JSON.parse(JSON.parse(y))
    }

    // initialize, render map
    function map_init (map, options) {
      // console.log('in map_init()')
      window.geom = {"type":"FeatureCollecton","features":[]}

      window.gelems = $('script').filter(function() {
        return this.id.match(/[0-9]/) && this.text != '"null"';
      });

      // TODO: location returned in TGN hit needs cleaning
      for (i=0;i<gelems.length;i++){
        let t_geom = cleanJson(gelems[i].text)
        // let t_geom = JSON.parse(JSON.parse(gelems[i].text))
        t_geom['properties'] = {"id": gelems[i].id, "dataset": "tgn"}
        geom['features'].push(t_geom)
      }

      function fill(dataset) {
        if (dataset == 'tgn')
          return "#ff7800"
        else if (dataset == 'dbp')
          return "#98E2FA"
        else
          return "#7AFF7A"
      }

      if (geom['features'].length > 0) {
        // console.log('geom: ',geom)
        idToFeature = {} // for feature lookup
        features = L.geoJSON(geom, {
          pointToLayer: function (feature, latlng) {
            matchid = feature.properties.dataset+':'+feature.properties.id
            marker = L.circleMarker(latlng,
              {
                radius: 8, fillOpacity: 0.8, opacity: 1, weight: 1,
                color: "#000", fillColor: fill(feature.properties.dataset)
              }
            ).bindPopup(feature.properties.dataset+':'+feature.properties.id);

            idToFeature[matchid] = marker
            return marker
          }
        }).addTo(map);

        if (geom['features'].length > 1) {
          map.fitBounds(features.getBounds().pad(1))
        } else {
          latlng = L.latLng(
            geom['features'][0].coordinates[1],
            geom['features'][0].coordinates[0])
          map.setView(latlng, 4)
        }

      } else {
        console.log('no geometries, no feature')
      }
    } // end map_init
  </script>
{% endblock %}
