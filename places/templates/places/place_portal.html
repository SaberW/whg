<!-- places/place_detail.html -->
{% extends "main/base.html" %}
{% load fontawesome %}
{% load static %}
{% load dataset_extras %}
{% load leaflet_tags %}

{% block title %}<title>Place::{{ place.title }}</title>{% endblock %}
{% block extra_head %}
  {% leaflet_js %}
  {% leaflet_css %}
{% endblock %}
{% block content %}
<div class="container">
  <div id="place_title">
    <h4>{{ place.title }} 
      <span class="small">{% if ccodes|length > 0 %} ({% for c in ccodes %}{{ c }} {% endfor %}){% endif %}</span>
      <span class="smaller float-right"> <i>whg:{{ whg_id }}</i>
        {% if place.dataset in spine %}<a href="" rel="tooltip" title="WHG spine record">
          <img src="{% static 'images/whg_logo_38h.png' %}" height="25px" class="textsub ml-2"/></a>
        {% endif %}
      </span>
    </h4>
  </div>
  <div id="place_tabset">
    <ul class="nav nav-tabs" id="myTab">
      <li class="nav-item">
        <a class="nav-link active" data-toggle="tab" href="#place_core" selected>Attestations</a>
      </li>
      <!--<li class="nav-item">-->
        <!--<a class="nav-link" data-toggle="tab" href="#place_discussion">Discussion</a>-->
      <!--</li>-->
    </ul>
    <div id="place_content" class="tab-content">
      <div id="place_core" class="tab-pane fade show active" >
        <div class="row pt-1">
          <div id="place_home_l" class="col-sm-5">
            <div class="col-content small mt-1"><p>{ auto-generated description } <i>future</i></p></div>
            {% for rec in payload %}
            <div class="col-content small mt-1">
              <div class="attest-header">
                <b>{{ rec.title }}</b> (<a href="/api/places/{{ rec.place_id }}/" target="_blank">pid:{{ rec.place_id }}</a>)
                <span class="float-right">
                  dataset: <a href="#" rel="tooltip" title="{ full title }" class="ttip">{{rec.dataset.label}}</a>
                </span>
              </div>
              <div class="attest-element">Variants: 
                {% for name in rec.names %}<i>{{name.toponym}}</i>
                {% if "http" in name.citation.id %}
                  (<a href="{{ name.citation.id }}" rel="tooltip"
                  title="{{name.citation.label}}" target="_blank">src</a>)
                {% endif %}
                {% if not forloop.last %}; {% endif %}
                {% endfor %}
              </div>
              <div class="attest-element">Types: {% for type in rec.types %}<i>{{type.label}}/{{type.src_label}}</i>
                {% if not forloop.last %}; {% endif %}{% endfor %}</div>
              <!-- put geoms into script -->
              {% if rec.geoms|length > 0 %}
                {% for g in rec.geoms %}
                  {{ g|json_script:rec.place_id }}
                {% endfor %}
              {% endif %}
              <div class="attest-element">Links: 
              {% for link in rec.links %}
                <a href="#" class="remote-link"><i>{{link.identifier}}</a> ({{link.type}})</i>
                {% if not forloop.last %}; {% endif %}{% endfor %}</div>
              {% if rec.descriptions %}
              <div class="attest-element abbrev">
              <div>Descriptions: {% for desc in rec.descriptions %}<i>{{desc.value}}</i>
                {% if not forloop.last %}; {% endif %}{% endfor %}</div>
              </div>
              {% endif %}
              {% if rec.whens %}
              <div class="attest-element">Temporal: {% for when in rec.whens %}{{when|truncatechars:130}}{% endfor %}</div>
              {% endif %}              
            </div>
            {% endfor %} <!-- rec in payload-->
            <div id="place_traces" class="col-content small mt-1">
              <p class="mb-0 allcap-heading">RELATED</p>
              <!-- auto-generate this-->
              <ul>
                <li>{ some relation }</li>
                <li>{ another relation }</li>
              </ul>
            </div>
          </div> <!-- place_home_l-->
          <div id="place_home_r" class="col-sm-7">
            <div id="place_temporal" class="col-content small">
              <p class="mb-0 allcap-heading">TEMPORAL ATTESTATIONS</p>
              <p> { summing temporal visualization } <i>future</i></p>
            </div>
            <div id="place_map" class="col-content small">
                <p class="mb-0 allcap-heading">GEOGRAPHY
                    <span class="float-right"><a href="javascript:getClose()">
                      {% fontawesome_icon 'search-plus' color='#336699' %}</a>
                </p>
                <div id="map">{% leaflet_map "map" callback="map_init" %}</div>
            </div>
            <div id="place_traces" class="col-content small mt-1">
              <p class="mb-0 allcap-heading">TRACES</p>
              <!-- auto-generate this-->
              <ul>
                <li>{ some event trace }</li>
                <li>{ some person trace }</li>
                <li>{ some document trace }</li>
              </ul>
            </div>
          </div> <!-- place_home_r -->
        </div> <!-- row -->          
      </div> <!-- place_core -->
      <div id="place_discussion" class="tab-pane fade">
        <div class="container pt-2">
          <h5>Discussion</h5>
        </div>
      </div> <!-- place_discussion -->
    </div> <!-- place_content -->
  </div> <!-- place_tabset -->
</div> <!-- top container -->

<script type="text/javascript">
  $(function() {
    $("[rel='tooltip']").tooltip();
    $(".remote-link").click(function(event) {
      event.preventDefault();
      console.log($(this).text())
      console.log(base_urls)
    })
  })
  window.addEventListener('map:init', function (e) {
    window.mappy = e.detail.map
    
    var attrib_mb = 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
            '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
      attrib_awmc = 'Tiles and Data &copy; 2013 <a href="http://www.awmc.unc.edu" target="_blank">AWMC</a>',
      token_mb = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw',
      token_kg = 'pk.eyJ1Ijoia2dlb2dyYXBoZXIiLCJhIjoiUmVralBPcyJ9.mJegAI1R6KR21x_CVVTlqw',
      token_awmc = 'pk.eyJ1Ijoia2dlb2dyYXBoZXIiLCJhIjoiY2prcmgwc2cwMjRuZzNsdGhzZmVuMDRqbCJ9.MeLsyeOqwhTRdvt_Hgo7kg',
      token_whg = '',
      mbtiles_url = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={token}';
      mbstyle_url = 'https://api.mapbox.com/styles/v1/{id}/tiles/256/{z}/{x}/{y}?access_token={token}';
      
    var awmc = L.tileLayer(mbtiles_url, {id:'isawnyu.map-knmctlkh', token:token_awmc, attribution:attrib_awmc}),
      grayscale = L.tileLayer(mbstyle_url, {id:'kgeographer/cjstfpenh6o1e1fldz95w8m6p', token:token_kg, attribution:attrib_mb}),
      satellite  = L.tileLayer(mbtiles_url, {id:'mapbox.satellite', token:token_mb, attribution:attrib_mb});

    var baseLayers = {
      "AWMC Terrain": awmc,
      "Spine Data": grayscale,
      "Satellite": satellite
    };
    L.control.layers(baseLayers).addTo(mappy);
    baseLayers['AWMC Terrain'].addTo(mappy)
  }, false);

  function getClose() {
    <!--mappy.setZoom(mappy.getZoom()+2)-->
    mappy.fitBounds(features.getBounds().pad(3))
  }
  function renderMap(geom){
    <!--clear out the previous if any-->
    if(typeof(features)!=='undefined'){
      mappy.removeLayer(features)
    }
    function fill(dataset) {
       if (dataset == 'tgn')
         return "#ff7800"
       else if (dataset == 'dbp')
         return "#98E2FA"
       else
         return "#7AFF7A"
    }
    idToFeature = {}  // for feature lookup
    features = L.geoJSON(geom, {
    // TODO: for some reason linestrings are parsed and rendered here
      pointToLayer: function (feature, latlng) {
        <!--console.log(feature)-->
        identifier = 'whg:'+feature.properties.id
        marker = L.circleMarker(latlng,
          {
            radius: 8, fillOpacity: 0.8, opacity: 1, weight: 1,
            color: "#000", fillColor: fill(feature.properties.dataset)
          }
        ).bindPopup(identifier);
     
        idToFeature[feature.properties.id] = marker
        return marker
      }
    }).addTo(mappy);
    
    // TODO: better zoomto choices
    <!--zoom_point = centroid(features.getBounds())-->
    center=features.getBounds().getCenter()
    mappy.setView(center, 5)
    <!--if (geom['features'].length > 1) {-->
      <!--mappy.fitBounds(features.getBounds().pad(1))-->
    <!--} else {-->
      <!--feat0 = geom['features'][0]-->
      <!--if (['Point','MultiPoint'].includes(feat0.type)) {-->
        <!--latlng = L.latLng(-->
          <!--feat0.coordinates[1],-->
          <!--feat0.coordinates[0])-->
        <!--mappy.setView(latlng, 3)-->
      <!--} else if (['MultiLineString','MultiPolygon'].includes(feat0.type)) {-->
        <!--mappy.fitBounds(features.getBounds())-->
      <!--}-->
    <!--}-->
  }

  // initialize, render map w/settings.LEAFLET_CONFIG
  function map_init (map, options) {
    <!--console.log('in map_init()')-->
    geom = {"type":"FeatureCollecton","features":[]}
    // gather geom script from html body
    window.gelems = $('script').filter(function() {
      return this.id.match(/[0-9]/) && this.text != '"null"';
    });

    // 
    for (i=0;i<gelems.length;i++){
      <!--let t_geom = cleanJson(gelems[i].text)-->
      let g = JSON.parse(gelems[i].text)
      g['properties'] = {"id": gelems[i].id}
      geom['features'].push(g)
    }
    renderMap(geom)
  } // end map_init
</script>
{% endblock %}

<!--rec: {'dataset': {'id': 1, 'label': 'black'}, 'whg_id': 82499, 'src_id': '11548', 'purl': 'http://whgazetteer.org/api/places/82499', 'title': 'Calusa', 'ccodes': [], 'names': [{'lang': None, 'toponym': 'Calusa', 'citation': {'id': 'black', 'label': 'DK Atlas of World History'}}], 'types': [{'label': 'cultural group', 'src_label': 'people', 'identifier': 'aat:300387171'}], 'links': [{'type': 'closeMatch', 'identifier': 'dplace:B46'}, {'type': 'closeMatch', 'identifier': 'dbp:Calusa'}], 'geoms': [], 'whens': [{'timespans': [{'end': {'in': 1600}, 'start': {'in': 1492}}, {'end': {'in': 1750}, 'start': {'in': 1600}}]}], 'related': [], 'descriptions': [], 'depictions': []} -->
