<!-- places/place_detail.html -->
{% extends "main/base.html" %}
{% load fontawesome %}
{% load static %}
{% load dataset_extras %}
{% load leaflet_tags %}

{% block title %}<title>Place::{{ place.title }}</title>{% endblock %}
{% block extra_head %}
  {% leaflet_js %}
  {% leaflet_css %}
{% endblock %}
{% block content %}
<div class="container">
  <div id="place_title">
    <h4>{{ place.title }} 
      <span class="small">{% if ccodes|length > 0 %} ({% for c in ccodes %}{{ c }} {% endfor %}){% endif %}</span>
      <span class="smaller float-right"> <i>{{ purl }}</i>
        {% if place.dataset in spine %}<a href="" rel="tooltip" title="WHG spine record">
          <img src="{% static 'images/whg_logo_38h.png' %}" height="25px" class="textsub ml-2"/></a>
        {% endif %}
      </span>
    </h4>
  </div>
  <div id="place_tabset">
    <ul class="nav nav-tabs" id="myTab">
      <li class="nav-item">
        <a class="nav-link active" data-toggle="tab" href="#place_core" selected>Attestations</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-toggle="tab" href="#place_discussion">Discussion</a>
      </li>
    </ul>
    <div id="place_content" class="tab-content">
      <div id="place_core" class="tab-pane fade show active" >
        <div class="row pt-1">
          <div id="place_home_l" class="col-sm-5">
            <div class="col-content small mt-1"><p>{ auto-generated description } <i>future</i></p></div>
            {% for rec in payload %}
            <div class="col-content small mt-1">
              <table class="table table-striped">
                <thead class="small">
                  <th>dataset</th>
                  <th>whg_id</th>
                  <th>src_id</th>
                  <th>title</th>
                </thead>
                <tbody>
                  <tr class="place-row">
                    <td>{{ rec.dataset.label }} ({{rec.dataset.id}})</td>
                    <td>{{ rec.whg_id }}</td>
                    <td>{{ rec.src_id }}</td>
                    <td>{{ rec.title }}</td>
                  </tr>
                </tbody>
              </table>
              <p><b>Variants</b>: {% for name in rec.names %}<i>
                {{name.toponym}} (<a href="" rel="tooltip" title="{{name.citation.label}}">src</a>) </i>
                {% if not forloop.last %}; {% endif %}{% endfor %}</p>
              <p><b>Types</b>: {% for type in rec.types %}<i>{{type.label}}/{{type.src_label}}</i>
                {% if not forloop.last %}; {% endif %}{% endfor %}</p>
              <!-- put geoms into script -->
              {% if rec.geoms|length > 0 %}
                {% for g in rec.geoms %}
                  {{ g|json_script:rec.whg_id }}
                {% endfor %}
              {% endif %}
              {% if rec.whens %}
              <p><b>Temporal</b>: {% for when in rec.whens %}{{when}}{% endfor %}</p>
              {% endif %}
              <p><b>Links</b>: {% for link in rec.links %}<i>{{link.identifier}} ({{link.type}})</i>
                {% if not forloop.last %}; {% endif %}{% endfor %}</p>
              {% if rec.descriptions %}
              <div class="abbrev">
              <p><b>Descriptions</b>: {% for desc in rec.descriptions %}<i>{{desc.value}}</i>
                {% if not forloop.last %}; {% endif %}{% endfor %}</p>
              </div>
              {% endif %}
              
            </div>
            {% endfor %}

<!--rec: {'dataset': {'id': 1, 'label': 'black'}, 'whg_id': 82499, 'src_id': '11548', 'purl': 'http://whgazetteer.org/api/places/82499', 'title': 'Calusa', 'ccodes': [], 'names': [{'lang': None, 'toponym': 'Calusa', 'citation': {'id': 'black', 'label': 'DK Atlas of World History'}}], 'types': [{'label': 'cultural group', 'src_label': 'people', 'identifier': 'aat:300387171'}], 'links': [{'type': 'closeMatch', 'identifier': 'dplace:B46'}, {'type': 'closeMatch', 'identifier': 'dbp:Calusa'}], 'geoms': [], 'whens': [{'timespans': [{'end': {'in': 1600}, 'start': {'in': 1492}}, {'end': {'in': 1750}, 'start': {'in': 1600}}]}], 'related': [], 'descriptions': [], 'depictions': []} -->

          </div> <!-- place_home_l-->
          <div id="place_home_r" class="col-sm-7">
            <div id="place_temporal" class="col-content small">
                {% if rec.whens|length > 0 %}
                    <p class="mb-0 allcap-heading">TEMPORAL</p>
                        {% for w in rec.whens %}
                            <p class="mb-1" ><i>min/max: </i> {{ w.minmax }}
                            <p><i>timespans: </i> {{ w.json|parse:'timespans'|truncatechars:200 }}
                        {% endfor %}
                    </p>
                {% else %}
                    <p> { summing temporal visualization } <i>future</i></p>
                {% endif %}
            </div>
            <!--<div class="row mt-1">-->
              <div id="place_map" class="col-content small">
                  <p class="mb-0 allcap-heading">GEOGRAPHY
                      <span class="float-right"><a href="javascript:getClose()">
                        {% fontawesome_icon 'search-plus' color='#336699' %}</a>
                  </p>
                  <div id="map">{% leaflet_map "map" callback="map_init" %}</map>
              </div>
            <!--</div> <!-- row -->
          </div> <!-- place_home_r -->
        </div> <!-- row -->          
      </div> <!-- place_core -->
      <div id="place_discussion" class="tab-pane fade">
        <div class="container pt-2">
          <h5>Discussion</h5>
        </div>
      </div> <!-- place_discussion -->
    </div> <!-- place_content -->
  </div> <!-- place_tabset -->
</div> <!-- top container -->

<script type="text/javascript">
  $("[rel='tooltip']").tooltip();
  
  window.addEventListener('map:init', function (e) {
    window.mappy = e.detail.map
  }, false);
  
  function parseChild(c) {
    // names{toponym,citation{id,label}},types{label,src_label,identifier}, 
    // descriptions{value}, geoms{geowkt,type,coordinates},
    html = '<div class="child-record"><p class="font-weight-bold">'+
      c['place_id']+' ('+c['dataset']+':'+c['src_id']+')</p>'+
      '<p><i>title</i>: '+c['title']+'('+c['ccodes']+')</p>'
    if (c['types'].length > 0) {
      html += '<p><i>type(s)</i>: '
      for (t in c['types']) {
        html += c['types'][t]['src_label']
      }
      html += '</p>'
    }
    if (c['descriptions'].length > 0) {
      html += '<p><i>description(s)</i>: </p><div style="max-height:75px; overflow:scroll;">'
      for (d in c['descriptions']) {
        html += c['descriptions'][d]['value']
      }
      html += '</p>'
    }
    html+='</div>'
    <!--console.log(c['geoms'])-->
    if (c['geoms'].length > 0){
      geom = {"type":"FeatureCollecton","features":[]}
      for (g in c['geoms']){
        c['geoms'][g]['properties'] = {"id": c['place_id'], "dataset": c['dataset']}
        geom.features.push(c['geoms'][g])
      }
      renderMap(geom)
    } 

    return html
  }
  function getClose() {
    <!--mappy.setZoom(mappy.getZoom()+2)-->
    mappy.fitBounds(features.getBounds().pad(3))
  }
  function renderMap(geom){
    <!--clear out the previous if any-->
    if(typeof(features)!=='undefined'){
      mappy.removeLayer(features)
    }
    function fill(dataset) {
       if (dataset == 'tgn')
         return "#ff7800"
       else if (dataset == 'dbp')
         return "#98E2FA"
       else
         return "#7AFF7A"
     }
    idToFeature = {}  // for feature lookup
    features = L.geoJSON(geom, {
    // TODO: for some reason linestrings are parsed and rendered here
     pointToLayer: function (feature, latlng) {
       matchid = feature.properties.dataset+':'+feature.properties.id
       marker = L.circleMarker(latlng,
         {
           radius: 8, fillOpacity: 0.8, opacity: 1, weight: 1,
           color: "#000", fillColor: fill(feature.properties.dataset)
         }
       ).bindPopup(feature.properties.dataset+':'+feature.properties.id);
    
       idToFeature[matchid] = marker
       return marker
     }
    }).addTo(mappy);
    
    // TODO: better zoomto choices
    <!--zoom_point = centroid(features.getBounds())-->
    center=features.getBounds().getCenter()
    mappy.setView(center, 5)
    <!--if (geom['features'].length > 1) {-->
      <!--mappy.fitBounds(features.getBounds().pad(1))-->
    <!--} else {-->
      <!--feat0 = geom['features'][0]-->
      <!--if (['Point','MultiPoint'].includes(feat0.type)) {-->
        <!--latlng = L.latLng(-->
          <!--feat0.coordinates[1],-->
          <!--feat0.coordinates[0])-->
        <!--mappy.setView(latlng, 3)-->
      <!--} else if (['MultiLineString','MultiPolygon'].includes(feat0.type)) {-->
        <!--mappy.fitBounds(features.getBounds())-->
      <!--}-->
    <!--}-->
  }

  
  
  
  $(function() {
    <!--html=''-->
    <!--window.children = JSON.parse(document.getElementById('kid-data').textContent)['hits'];-->
    <!--for(i in children) {-->
      <!--var c = children[i]['_source']-->
      <!--html += parseChild(c)-->
    <!--}-->
    <!--$("#child_content").html(html)-->
  })
  
  function cleanJson(text) {
    z=text.replace(/'/g,'\\"')
    y=z.replace(/point/,'Point')
    return JSON.parse(JSON.parse(y))
  }

  // initialize, render map w/settings.LEAFLET_CONFIG
  function map_init (map, options) {
    console.log('in map_init()')
    geom = {"type":"FeatureCollecton","features":[]}
    // gather geom script from html body
    window.gelems = $('script').filter(function() {
      return this.id.match(/[0-9]/) && this.text != '"null"';
    });

    // 
    for (i=0;i<gelems.length;i++){
      <!--let t_geom = cleanJson(gelems[i].text)-->
      let g = JSON.parse(gelems[i].text)
      g['properties'] = {"id": gelems[i].id}
      geom['features'].push(g)
    }
    console.log('geom on init',geom)
    renderMap(geom)
  } // end map_init
</script>
{% endblock %}
