<!-- areas/area_create.html -->
{% extends "main/base.html" %}
{% load leaflet_tags %}
{% load fontawesome %}
{% load static %}
{% block title %}<title>WHG::Create/Update Area</title>{% endblock %}
{% block extra_head %}
  {% leaflet_js %}
  {% leaflet_css %}
  <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
  <script src="{% static 'js/leaflet-draw/Leaflet.draw.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/Leaflet.Draw.Event.js' %}"></script>
  <link rel="stylesheet" href="{% static 'js/leaflet-draw/leaflet.draw.css' %}"/>

  <script src="{% static 'js/leaflet-draw/Toolbar.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/Tooltip.js' %}"></script>

  <script src="{% static 'js/leaflet-draw/ext/GeometryUtil.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/ext/LatLngUtil.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/ext/LineUtil.Intersect.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/ext/Polygon.Intersect.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/ext/Polyline.Intersect.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/ext/TouchEvents.js' %}"></script>

  <script src="{% static 'js/leaflet-draw/draw/DrawToolbar.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/draw/handler/Draw.Feature.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/draw/handler/Draw.SimpleShape.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/draw/handler/Draw.Polyline.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/draw/handler/Draw.Marker.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/draw/handler/Draw.Circle.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/draw/handler/Draw.CircleMarker.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/draw/handler/Draw.Polygon.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/draw/handler/Draw.Rectangle.js' %}"></script>

  <script src="{% static 'js/leaflet-draw/edit/EditToolbar.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/edit/handler/EditToolbar.Edit.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/edit/handler/EditToolbar.Delete.js' %}"></script>

  <script src="{% static 'js/leaflet-draw/Control.Draw.js' %}"></script>

  <script src="{% static 'js/leaflet-draw/edit/handler/Edit.Poly.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/edit/handler/Edit.SimpleShape.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/edit/handler/Edit.Rectangle.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/edit/handler/Edit.Marker.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/edit/handler/Edit.CircleMarker.js' %}"></script>
  <script src="{% static 'js/leaflet-draw/edit/handler/Edit.Circle.js' %}"></script>
  {% endblock %}

{% block content %}
  <div class="container">
    <h4 class="mt-3">
      {% if action == 'update' %}
      Update Study Area
      <a href="{% url 'areas:area-delete' object.id %}" class="float-right"
        title="Delete dataset" rel="tooltip" style="margin-top:-2px;">
        {% fontawesome_icon 'trash' color='#336699' %}</a>
      {% else %}Create Study Area{% endif %}
        <span class="small">{% fontawesome_icon 'question-circle' color='#336699' %}</span>
    </h4>
    <div class="d-flex">
      <div class="form-box mt-2 col-sm-6">
        <form id="ds_form" method="POST" action="#" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="owner" value='{{ user.id }}'></input>
          <input type="hidden" name="type" value='ccodes'></input>
          <p>Title: {{ form.title }}</p>
          {% if errors %}<p>{{ errors }}</p>{% endif %}
          <p><span class="top">Description:</span> {{ form.description }}</p>
          <p id="p_ccodes">Country codes: {{ form.ccodes }}
            <span class="float-right">
              <a href="javascript:{ map_render() }">preview</a></span>
          </p>
          <p id="p_geom" class="hidden"><span class="top">GeoJSON:</span>
            {{ form.geom }}
          </p>
          <!-- upload button only if it's not yet ok -->
          <!-- {# if status != 'format_ok' #} -->
          <input class="btn btn-primary" type="submit" value="Save" />
          <span title="back"><a href="{% url 'dashboard' %}">Cancel</a></span>
          <!-- {# endif #} -->
        </form>
        <hr />
        <i class="mt-3"><b>work-in-progress</b>: load countries, generate hull, edit, save</i>
      </div>
      <div id="area_map" class="col-sm-6 ml-3">
        {% leaflet_map "map" callback="map_init" %}
      </div>
    </div> <!-- d-flex -->
  </div> <!-- container -->
  <script type="text/javascript">
    $(function(){
      $( ".textarea" ).each(function(index) {
        if ( ["None","null"].includes( $(this).val() ) ) {
          $(this).val('')
        }
      });
    })
    // expose leaflet map for events, call it 'mappy'
    window.addEventListener('map:init', function (event) {
      window.mappy = event.detail.map
    }, false);

    function zoomTo(id) {
      mappy.setView(idToFeature[id]._latlng, mappy.getZoom() +2 )
    }

    function cleanJson(text) {
      z=text.replace(/'/g,'\\"')
      y=z.replace(/point/,'Point')
      return JSON.parse(JSON.parse(y))
    }

    function map_render() {
      console.log('in map_render()')
      ccodes = $("input#id_ccodes").val()
      window.geoj = $("textarea#id_geom")
      window.geom = {"type":"FeatureCollection","features":[]}
      // console.clear()

      var country_url = "/media/data/countries_simplified.json"
      // clear geoJSON
      if (Object.keys(mappy._layers).length >1 ) {
        cc_layer.clearLayers()
      }
      if (ccodes != '') {
        // TODO: test csv format
        $("#p_geom").show()
        ccode_arr = ccodes.toUpperCase().split(",")
        // console.log(ccode_arr)
        fetch(country_url)
          .then(function(resp) {
            return resp.json();
          })
          .then(function(data) {
            // console.log('fetched data', data)
            window.cc_layer = L.geoJson(data, {
              filter: function(feature, layer) {
                return ccode_arr.includes(feature.properties.iso) ;
              },
              onEachFeature: function onEachFeature(feature, layer) {
                // console.log('feature:', JSON.stringify(feature))
                geom['features'].push(feature)
                var props = feature.properties;
                var content = `<p>${props.iso}</p><p>${props.gnlabel}</p>`;
                layer.bindPopup(content);
            }}).addTo(mappy);
            mappy.fitBounds(cc_layer.getBounds())
          })
          .then(function(){
            hull = turf.convex(geom)
            // console.log('hull:',hull)
            // geoj.val(JSON.stringify(geom))
            geoj.val(JSON.stringify(hull))
            hull_layer = L.geoJSON(hull, {
              style: function (feature) {
                return {color: '#ff8c00'}; }
            }).addTo(mappy);
            var drawControl = new L.Control.Draw({
              draw: {
                 marker: false,
                 polyline: false,
                 circle: false,
                 circlemarker: false,
             },
              edit: {
                 featureGroup: hull_layer
              }
            });
            mappy.addControl(drawControl);
            // TODO: save edits
            mappy.on(L.Draw.Event.CREATED, function (event) {
                var layer = event.layer;
                hull_layer.addLayer(layer);
            });
          })
      } else {
        // alert('Need some comma-delimited 2-letter country codes')
      }
    }
    // initialize, render map w/settings.LEAFLET_CONFIG
    function map_init (map, options) {
      // console.log('mappy',mappy)
      window.geoj = $("textarea#id_geom.textarea")
      // console.log('in map_init(), geoj.val()',geoj.val())
      // drawnItems = L.featureGroup().addTo(map);
      // // hull_layer = L.geoJSON(hull, {
      // //   style: function (feature) {
      // //     return {color: '#ff8c00'}; }
      // // }).addTo(mappy);
      // var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
      // var osm = L.tileLayer(osmUrl, { maxZoom: 18, attribution: 'osm' })
      // L.control.layers(
      //   {'osm': osm.addTo(map)},
      //   {'drawlayer': drawnItems},
      //   { position: 'topleft', collapsed: false }
      // ).addTo(map);
      // var drawControl = new L.Control.Draw({
      //   draw: {
      //      marker: false,
      //      polyline: false,
      //      circle: false,
      //      circlemarker: false,
      //  },
      //   edit: {
      //      featureGroup: drawnItems
      //   }
      // });
      // map.addControl(drawControl);
      // // TODO: save edits
      // map.on(L.Draw.Event.CREATED, function (event) {
      //     window.drawnlayer = event.layer;
      //     geoj.val(JSON.stringify(drawnlayer.toGeoJSON().geometry))
      //     drawnItems.addLayer(drawnlayer);
      //     $("#p_geom").show()
      // });
      if (geoj.val() != ''){
        $("#p_geom").show()
        map_render()
      }
    } // end map_init
  </script>
{% endblock %}

<!-- // window.gelems = $('script').filter(function() {
//   return this.id.match(/[0-9]/) && this.text != '"null"';
// });

// for (i=0;i<gelems.length;i++){
//   let t_geom = cleanJson(gelems[i].text)
//   // let t_geom = JSON.parse(JSON.parse(gelems[i].text))
//   t_geom['properties'] = {"id": gelems[i].id, "dataset": "tgn"}
//   geom['features'].push(t_geom)
// } -->
