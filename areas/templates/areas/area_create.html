<!-- areas/area_create.html -->
{% extends "main/base.html" %}
{% load leaflet_tags %}
{% load fontawesome %}
{% block title %}<title>WHG::Create/Update Area</title>{% endblock %}
{% block extra_head %}
  {% leaflet_js %}
  {% leaflet_css %}
{% endblock %}

{% block content %}
  {% load static %}
  <div class="container">
    <h4 class="mt-3">
      {% if action == 'update' %}
      Update{% else %}Create{% endif %} Study Area
        <span class="small">{% fontawesome_icon 'question-circle' color='#336699' %}</span>
    </h4>
    <div class="d-flex">
      <div class="form-box mt-2 col-sm-6">
        <form id="ds_form" method="POST" action="#" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="owner" value='{{ user.id }}'></input>
          <p>Title: {{ form.title }}</p>
          {% if errors %}<p>{{ errors }}</p>{% endif %}
          <p><span class="top">Description:</span> {{ form.description }}</p>
          <p id="p_ccodes">Country codes: {{ form.ccodes }}
            <span class="float-right">
              <a href="javascript:{ map_render() }">preview</a></span>
          </p>
          <p><b>OR...</b></p>
          <p id="p_geom"><span class="top">GeoJSON:</span>
            {{ form.geom }}
          </p>
          <!-- upload button only if it's not yet ok -->
          <!-- {# if status != 'format_ok' #} -->
          <input class="btn btn-primary" type="submit" value="Save" />
          <span title="back"><a href="{% url 'dashboard' %}">Cancel</a></span>
          <!-- {# endif #} -->
        </form>
      </div>
      <div id="map" class="col-sm-6 ml-3">
        {% leaflet_map "map" callback="map_init" %}
      </div>
    </div> <!-- d-flex -->
  </div> <!-- container -->
  <script type="text/javascript">
    $(function(){
      $('.textarea').html('') //clears string 'None' ?? huh
    })
    // expose leaflet map for events, call it 'mappy'
    window.addEventListener('map:init', function (event) {
      window.mappy = event.detail.map
    }, false);

    function zoomTo(id) {
      mappy.setView(idToFeature[id]._latlng, mappy.getZoom() +2 )
    }

    function cleanJson(text) {
      z=text.replace(/'/g,'\\"')
      y=z.replace(/point/,'Point')
      return JSON.parse(JSON.parse(y))
    }

    function map_render() {
      console.log('map_render')
      ccodes = $("input#id_ccodes").val()
      geoj = $("textarea#id_geom.textarea").val()
      console.clear(); console.log('codes',ccodes); console.log('geoj',geoj)

      // console.log('got mappy?', mappy)
      // window.countries = new L.geoJson();
      // countries.addTo(mappy);
      var country_url = "/media/data/countries_simplified.json"

      if (ccodes != '') {
        // TODO: test csv format
        ccode_arr = ccodes.split(",")
        console.log(ccode_arr)
        fetch(country_url)
          .then(function(resp) {
            return resp.json();
          })
          .then(function(data) {
            console.log('fetched data', data)
            L.geoJson(data, {
              filter: function(feature, layer) {
                return ccode_arr.includes(feature.properties.iso) ;
              },
              onEachFeature: function onEachFeature(feature, layer) {
                // console.log('feature:',feature)
                var props = feature.properties;
                var content = `<p>${props.iso}</p><p>${props.gnlabel}</p>`;
                layer.bindPopup(content);
            }}).addTo(mappy);
          })
        }
        // L.geoJson(someFeatures, {
        //   filter: function(feature, layer) {
        //       return feature.properties.show_on_map;
        //   }
        // }).addTo(map);}
      // $.ajax({
      //   dataType: "json",
      //   url: "/media/data/countries_simplified.json",
      //   success: function(data) {
      //       $(data.features).each(function(key, data) {
      //           countries.addData(data);
      //       });
      //   }
      // })

      // L.geoJSON(data, {
      //     style: function (feature) {
      //         return {color: feature.properties.color};
      //     }
      // }).bindPopup(function (layer) {
      //     return layer.feature.properties.gnlabel;
      // }).addTo(mappy);
      //
      // L.geoJSON(someFeatures, {
      //     filter: function(feature, layer) {
      //         return feature.properties.show_on_map;
      //     }
      // }).addTo(map);

      window.coors = {
          "type": "Feature",
          "properties": {
              "name": "Coors Field",
              "amenity": "Baseball Stadium",
              "popupContent": "This is where the Rockies play!"
          },
          "geometry": {
              "type": "Point",
              "coordinates": [-104.99404, 39.75621]
          }
      };
      // countries.addData(coors)
      function centerLeafletMapOnMarker(map, marker) {
        var latLngs = [ marker.getLatLng() ];
        var markerBounds = L.latLngBounds(latLngs);
        map.fitBounds(markerBounds);
      }
    }

    // initialize, render map w/settings.LEAFLET_CONFIG
    function map_init (map, options) {
      console.log('in map_init()')
    } // end map_init
  </script>
{% endblock %}

<!-- // window.gelems = $('script').filter(function() {
//   return this.id.match(/[0-9]/) && this.text != '"null"';
// });

// for (i=0;i<gelems.length;i++){
//   let t_geom = cleanJson(gelems[i].text)
//   // let t_geom = JSON.parse(JSON.parse(gelems[i].text))
//   t_geom['properties'] = {"id": gelems[i].id, "dataset": "tgn"}
//   geom['features'].push(t_geom)
// } -->
